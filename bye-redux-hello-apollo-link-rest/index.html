<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/assets/css/default.css?1713719965020379318">
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/monokai.css">
    <link rel="stylesheet" href="/assets/css/world.css">
    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Getting rid of Redux / apollo-link-rest with Next.js &middot; bitgate</title>
    <link type="application/atom+xml" rel="alternate" href="https://blog.bitgate.cz/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Getting rid of Redux / apollo-link-rest with Next.js" />
<meta name="author" content="daniel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TL;DR I ditched Redux in favor of Apollo. This is how I set up apollo-link-rest." />
<meta property="og:description" content="TL;DR I ditched Redux in favor of Apollo. This is how I set up apollo-link-rest." />
<link rel="canonical" href="https://blog.bitgate.cz/bye-redux-hello-apollo-link-rest/" />
<meta property="og:url" content="https://blog.bitgate.cz/bye-redux-hello-apollo-link-rest/" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-26T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Getting rid of Redux / apollo-link-rest with Next.js" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"daniel"},"dateModified":"2020-03-26T00:00:00+00:00","datePublished":"2020-03-26T00:00:00+00:00","description":"TL;DR I ditched Redux in favor of Apollo. This is how I set up apollo-link-rest.","headline":"Getting rid of Redux / apollo-link-rest with Next.js","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.bitgate.cz/bye-redux-hello-apollo-link-rest/"},"url":"https://blog.bitgate.cz/bye-redux-hello-apollo-link-rest/"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <button id="theme-toggle" class="hidden sm:block fixed z-10 top-30 right-30 border-none rounded-sm -mx-[5px] px-[5px] hover:bg-dark/10 dark:hover:bg-light/10">
  <span class="hidden dark:inline" title="switch to light theme">☀</span>
  <span class="dark:hidden" title="switch to dark theme">☽</span>
</button>

    
  <button id="start-stop" title="start/pause simulation" class="hidden sm:block fixed z-10 bottom-30 right-30 border-none rounded-sm -mx-[5px] px-[5px] hover:bg-dark/10 dark:hover:bg-light/10">
    &#x23F5;
  </button>
  <div id="world"></div>
  <script src="/assets/world.js"></script>



    <div class="golden bg-grid relative z-10 w-901">
      <nav class="flex justify-center space-x-30 sm:space-x-60 underline">
  
    <a href="/">/</a>
  
    <a href="/about">/about</a>
  
    <a href="/archive">/archive</a>
  
    <a href="/tags">/tags</a>
  
</nav>

      <main class="mt-30 md:mt-60 max-w-none prose">
        <h1>Getting rid of Redux / apollo-link-rest with Next.js</h1>
<p class="text-sm text-muted my-15">
  written by daniel in
  
    <a href="/tags/frontend"><code>frontend</code></a>
  
  on 26 Mar 2020
</p>
<p><strong>TL;DR</strong> I ditched Redux in favor of Apollo. This is how I set up <code class="language-plaintext highlighter-rouge">apollo-link-rest</code>.</p>

<p>Having worked with a Next.js setup with Apollo, Redux and a ton of other libraries recently, I grew somewhat impatient with the seconds-long hot-reload build times, minutes-long production builds and a 500 MB+ Docker context.
So, while setting up a frontend stack for a work project recently, my #1 aim was to make it as light-weight as possible.
This led me to reconsider every dependency in my setup.</p>

<p>Now Redux is not a great example of a bloated library, with its 348 KB including all dependencies.
But it does add complexity when mixed together with Apollo and SSR.
I reviewed what I actually used Redux for in my last project and decided to cut it.</p>

<h2 id="redux-use-cases">Redux use cases</h2>

<p>I found that I had these two use-cases for Redux:</p>

<ul>
  <li>managing global state</li>
  <li>separating async logic into thunks</li>
</ul>

<p>For global state, Apollo was an obvious choice.
Apollo supports client-side state management out of the box since Apollo Client 2.5.
At first I found using queries and mutations to manage state somewhat cumbersome, but it’s not too too bad and there are bright sides as well: no actions, resolvers instead of reducers, being able to query local state in the same query as remote data.
And from my (brief) experience, there is only so much global state to manage anyways.
Authentication, global notifications, and… that’s it?
Most of the time I try to keep state in components.</p>

<p>As for async logic - most of my thunks did not need access to Redux store anyway and could therefore be replaced with async event handlers.
A custom hook will take care of the rest.</p>

<h2 id="handling-rest-requests">Handling REST requests</h2>

<p>I decided to give <code class="language-plaintext highlighter-rouge">apollo-link-rest</code> a try, since I had Apollo already set up.
<code class="language-plaintext highlighter-rouge">Apollo-link-rest</code> allows you to write GraphQL queries against REST endpoints.
Because it’s an Apollo link, there is no need for separate error and authorization handling in addition to your GraphQL queries — <code class="language-plaintext highlighter-rouge">apollo-link-error</code> and <code class="language-plaintext highlighter-rouge">apollo-link-context</code> work for both GraphQL and <code class="language-plaintext highlighter-rouge">apollo-link-rest</code> requests.</p>

<h2 id="setting-up-apollo-link-rest">Setting up <code class="language-plaintext highlighter-rouge">apollo-link-rest</code></h2>

<p>The setup is as simple as creating a <code class="language-plaintext highlighter-rouge">RestLink</code> and adding it to you Apollo client.
I’m using Next.js <code class="language-plaintext highlighter-rouge">^9.3.1</code> with <code class="language-plaintext highlighter-rouge">@apollo/client ^3.0.0-beta</code>.
This is my <code class="language-plaintext highlighter-rouge">createApolloClient</code> function based on the <a href="https://github.com/zeit/next.js/tree/canary/examples/with-apollo" target="_blank">with-apollo</a> example by Next:</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">RestLink</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">apollo-link-rest</span><span class="dl">'</span>

<span class="c1">// …</span>

<span class="kd">const</span> <span class="nx">restLink</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RestLink</span><span class="p">({</span>
  <span class="na">uri</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REST_URL</span><span class="p">,</span>
<span class="p">})</span>

<span class="c1">// …</span>

<span class="k">return</span> <span class="k">new</span> <span class="nc">ApolloClient</span><span class="p">({</span>
  <span class="na">ssrMode</span><span class="p">:</span> <span class="nc">Boolean</span><span class="p">(</span><span class="nx">ctx</span><span class="p">),</span>
  <span class="na">link</span><span class="p">:</span> <span class="nx">ApolloLink</span><span class="p">.</span><span class="k">from</span><span class="p">([</span><span class="nx">authLink</span><span class="p">,</span> <span class="nx">errorLink</span><span class="p">,</span> <span class="nx">restLink</span><span class="p">,</span> <span class="nx">graphqlLink</span><span class="p">]),</span>
  <span class="nx">cache</span><span class="p">,</span>
  <span class="nx">typeDefs</span><span class="p">,</span>
  <span class="na">resolvers</span><span class="p">:</span> <span class="p">{},</span>
<span class="p">})</span>
</code></pre></div></div>

<p>This is the example Next.js + Apollo setup with an extra <code class="language-plaintext highlighter-rouge">authLink</code> and <code class="language-plaintext highlighter-rouge">errorLink</code>, and <code class="language-plaintext highlighter-rouge">typeDefs</code> and <code class="language-plaintext highlighter-rouge">resolvers</code> for local state management.</p>

<p>Beware of ordering of the links — <code class="language-plaintext highlighter-rouge">HttpLink</code> eats everything thrown at it and therefore needs to be last in the list.
We want to have <code class="language-plaintext highlighter-rouge">AuthLink</code> and <code class="language-plaintext highlighter-rouge">ErrorLink</code> applied to the other two, so they go first.</p>

<p>Aaaand it just works! Great.</p>

<p><img src="/assets/images/headers.png" alt="Screenshot of ReferenceError: Headers is not defined" /></p>

<p>Turns out SSR can reliably break just about anything at all.
<code class="language-plaintext highlighter-rouge">Apollo-link-rest</code> is apparently <a href="https://github.com/apollographql/apollo-link-rest/issues/182#issuecomment-453181542" target="_blank">not intended</a> for SSR use and relies on the browser <a href="https://developer.mozilla.org/en-US/docs/Web/API/Headers">Headers API</a> which is missing in our Node.js environment.
Let’s use <code class="language-plaintext highlighter-rouge">Header</code> from <code class="language-plaintext highlighter-rouge">node-fetch</code> as a polyfill: <code class="language-plaintext highlighter-rouge">yarn add node-fetch</code></p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// polyfill Headers API server-side for apollo-link-rest</span>
<span class="c1">// https://github.com/apollographql/apollo-link-rest/issues/182#issuecomment-453209304</span>
<span class="k">if </span><span class="p">((</span><span class="nb">global</span> <span class="k">as</span> <span class="kr">any</span><span class="p">).</span><span class="nx">Headers</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// eslint-disable-next-line @typescript-eslint/no-var-requires</span>
  <span class="kd">const</span> <span class="nx">fetch</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">node-fetch</span><span class="dl">'</span><span class="p">)</span>
  <span class="p">;(</span><span class="nb">global</span> <span class="k">as</span> <span class="kr">any</span><span class="p">).</span><span class="nx">Headers</span> <span class="o">=</span> <span class="nx">fetch</span><span class="p">.</span><span class="nx">Headers</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And there we have it 🥳 We can now do this:</p>

<pre><code class="language-gql">query TestRestQuery {
  healthcheck @rest(type: "Healthcheck", path: "/healthcheck") {
    status
  }
}
</code></pre>


      </main>
      
        <nav class="mt-150 flex justify-center space-x-30 sm:space-x-60 underline text-sm text-dark-80">
  
    <a href="/">/</a>
  
    <a href="/about">/about</a>
  
    <a href="/archive">/archive</a>
  
    <a href="/tags">/tags</a>
  
</nav>

      
    </div>

    <script>function applyTheme(theme) {
  document.documentElement.classList.toggle('dark', theme === 'dark')
}

const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
applyTheme(isDark ? 'dark' : 'light')

document.getElementById('theme-toggle').addEventListener('click', function() {
  const newTheme = !('theme' in localStorage) ?
    document.documentElement.classList.contains('dark') ? 'light' : 'dark' :
    localStorage.theme === 'dark' ? 'light' : 'dark'
  localStorage.theme = newTheme
  applyTheme(newTheme)
})
</script>
  </body>
</html>
