<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/assets/css/default.css">
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <link type="application/atom+xml" rel="alternate" href="/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Setting up a dev environment on GitLab pages</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Setting up a dev environment on GitLab pages" />
<meta name="author" content="daniel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TL;DR Preview changes to your GitLab pages by directly accessing job artifacts, without overwriting your pages deployment." />
<meta property="og:description" content="TL;DR Preview changes to your GitLab pages by directly accessing job artifacts, without overwriting your pages deployment." />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-03-21T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Setting up a dev environment on GitLab pages" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"daniel"},"dateModified":"2020-03-21T00:00:00+00:00","datePublished":"2020-03-21T00:00:00+00:00","description":"TL;DR Preview changes to your GitLab pages by directly accessing job artifacts, without overwriting your pages deployment.","headline":"Setting up a dev environment on GitLab pages","mainEntityOfPage":{"@type":"WebPage","@id":"/gitlab-pages-dev-env/"},"url":"/gitlab-pages-dev-env/"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body class="overflow-x-hidden">
    <button id="theme-toggle" class="hidden sm:block absolute top-30 right-30 border-none rounded-sm -mx-[5px] px-[5px] hover:bg-dark/10 dark:hover:bg-light/10">
  <span class="hidden dark:inline" title="switch to light theme">‚òÄÔ∏è</span>
  <span class="dark:hidden" title="switch to dark theme">üåë</span>
</button>

    <div class="golden bg-grid">
      <nav class="flex justify-center space-x-30 sm:space-x-60 underline">
  
    <a href="/">/</a>
  
    <a href="/about">/about</a>
  
    <a href="/archive">/archive</a>
  
    <a href="/tags">/tags</a>
  
</nav>

      <main class="mt-30 md:mt-60 max-w-none prose">
        <h1>Setting up a dev environment on GitLab pages</h1>
<p class="text-sm text-muted">
  written by daniel in
  
    <a href="/tags/devops"><code>devops</code></a>
  
  on 21 Mar 2020
</p>
<p><strong>TL;DR</strong> Preview changes to your GitLab pages by directly accessing job artifacts, without overwriting your pages deployment.</p>

<p>I recently needed to make a few changes to a static site hosted on GitLab pages.
I was looking for a way to deploy a work-in-progress version to a temporary location, without interfering with the production site.
I <a href="https://stackoverflow.com/a/58402821">found</a> a nifty way to do it using CI job artifacts, from a new branch in the same repo.</p>

<h2 id="basic-pages-deploy-setup">Basic pages deploy setup</h2>

<p>First, let‚Äôs set up the production environment.
We‚Äôll add a job named <code class="language-plaintext highlighter-rouge">pages</code> to our <code class="language-plaintext highlighter-rouge">.gitlab-ci.yml</code>, which tells GitLab to deploy the contents of the public folder in the master branch after the job succeeds:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pages</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">public</span>
  <span class="na">only</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">master</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">mkdir .public</span>
    <span class="pi">-</span> <span class="s">cp -r * .public</span>
    <span class="pi">-</span> <span class="s">mv .public public</span>
</code></pre></div></div>

<p>Since I keep all the files in the repository root, I move them to the public directory in this job ‚Äì you might not need to do this.
By limiting this job to master only, we make sure that pushing to any other branch does not overwrite the production deployment.</p>

<h2 id="deploying-a-dev-branch">‚ÄúDeploying‚Äù a dev branch</h2>

<p>GitLab only supports deploying pages from the public folder, but we‚Äôre already using that for production.
Instead of an actual pages deploy, let‚Äôs add a new job that will run on branches other than master.
We‚Äôll save its artifacts, which GitLab makes accessible on a specific URL.
We‚Äôll set that URL to an environment named <code class="language-plaintext highlighter-rouge">dev</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">dev-deploy</span><span class="pi">:</span>
  <span class="na">stage</span><span class="pi">:</span> <span class="s">deploy</span>
  <span class="na">artifacts</span><span class="pi">:</span>
    <span class="na">paths</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">public</span>
  <span class="na">except</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">master</span>
  <span class="na">environment</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">dev</span>
    <span class="na">url</span><span class="pi">:</span> <span class="s1">'</span><span class="s">https://$CI_PROJECT_NAMESPACE.gitlab.io/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/artifacts/public/index.html'</span>
  <span class="na">script</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">mkdir .public</span>
    <span class="pi">-</span> <span class="s">cp -r * .public</span>
    <span class="pi">-</span> <span class="s">mv .public public</span>
</code></pre></div></div>

<p>We define the public folder as an artifact, so that it‚Äôs not removed after the job finishes.
After the job succeeds, the dev branch deployment can be found at <code class="language-plaintext highlighter-rouge">https://$CI_PROJECT_NAMESPACE.gitlab.io/-/$CI_PROJECT_NAME/-/jobs/$CI_JOB_ID/</code> or more conveniently, in the <code class="language-plaintext highlighter-rouge">Operations &gt; Environments</code> menu, under the <code class="language-plaintext highlighter-rouge">View deployment</code> button.</p>

<h3 id="permissions">Permissions</h3>

<p>By default, only members of the project with access to CI pipelines will have permission to view job artifacts.
This can be changed in <code class="language-plaintext highlighter-rouge">Settings &gt; General</code>, section <code class="language-plaintext highlighter-rouge">Visibility &gt; Repository &gt; Pipelines</code>.
If you‚Äôd like the dev site to be public, you‚Äôll have to set the visibility of the entire project to public.</p>


      </main>
    </div>
    <script>
      function applyTheme(theme) {
  document.documentElement.classList.toggle('dark', theme === 'dark')
}

const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
applyTheme(isDark ? 'dark' : 'light')

document.getElementById('theme-toggle').addEventListener('click', function() {
  let newTheme
  if (!('theme' in localStorage)) {
    newTheme = document.documentElement.classList.contains('dark') ? 'light' : 'dark'
  } else {
    newTheme = localStorage.theme === 'dark' ? 'light' : 'dark'
  }

  localStorage.theme = newTheme
  applyTheme(newTheme)
})

    </script>
  </body>
</html>
