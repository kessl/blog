<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/assets/css/default.css?1657288168928927370">
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/monokai.css">
    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Home data storage with encrypted cloud backup &middot; bitgate</title>
    <link type="application/atom+xml" rel="alternate" href="/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Home data storage with encrypted cloud backup" />
<meta name="author" content="daniel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="I thought it would be a good idea to consolidate all my data to a central storage. Before I set this up, I had data all over the place: photos and documents on iCloud and OneDrive, old programming projects and very old documents scattered on random hard drives, games and music on my PC." />
<meta property="og:description" content="I thought it would be a good idea to consolidate all my data to a central storage. Before I set this up, I had data all over the place: photos and documents on iCloud and OneDrive, old programming projects and very old documents scattered on random hard drives, games and music on my PC." />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-01-13T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Home data storage with encrypted cloud backup" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"daniel"},"dateModified":"2021-01-13T00:00:00+00:00","datePublished":"2021-01-13T00:00:00+00:00","description":"I thought it would be a good idea to consolidate all my data to a central storage. Before I set this up, I had data all over the place: photos and documents on iCloud and OneDrive, old programming projects and very old documents scattered on random hard drives, games and music on my PC.","headline":"Home data storage with encrypted cloud backup","mainEntityOfPage":{"@type":"WebPage","@id":"/data-storage-with-encrypted-cloud-backup/"},"url":"/data-storage-with-encrypted-cloud-backup/"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body class="overflow-x-hidden">
    <button id="theme-toggle" class="hidden sm:block absolute top-30 right-30 border-none rounded-sm -mx-[5px] px-[5px] hover:bg-dark/10 dark:hover:bg-light/10">
  <span class="hidden dark:inline" title="switch to light theme">‚òÄÔ∏è</span>
  <span class="dark:hidden" title="switch to dark theme">üåë</span>
</button>

    <div class="golden bg-grid overflow-x-hidden">
      <nav class="flex justify-center space-x-30 sm:space-x-60 underline">
  
    <a href="/">/</a>
  
    <a href="/about">/about</a>
  
    <a href="/archive">/archive</a>
  
    <a href="/tags">/tags</a>
  
</nav>

      <main class="mt-30 md:mt-60 max-w-none prose">
        <h1>Home data storage with encrypted cloud backup</h1>
<p class="text-sm text-muted my-15">
  written by daniel in
  
    <a href="/tags/homelab"><code>homelab</code></a>
  
  on 13 Jan 2021
</p>
<p>I thought it would be a good idea to consolidate all my data to a central storage.
Before I set this up, I had data all over the place: photos and documents on iCloud and OneDrive, old programming projects and very old documents scattered on random hard drives, games and music on my PC.</p>

<p>I had a few requirements:</p>

<ul>
  <li>Central location for all my devices: I want to mount a share and copy files</li>
  <li>Backups: the central location should have versioned backups</li>
  <li>No proprietary solutions: I want to be in control of my data</li>
  <li>No vendor lock-in: There should be an option to switch cloud storage providers</li>
  <li>Encryption: The cloud backups need to be encrypted</li>
</ul>

<p>I decided to use an Odroid HC1 with an HDD.
The Odroid will advertise an NFS share and periodically back up its contents to a cloud storage.
I chose to go with <a href="https://www.backblaze.com/b2/cloud-storage.html" target="_blank">Backblaze</a>, which offers an S3-compatible object store at $0.005/GB.
First 10 GB are free.</p>

<h2 id="odroid-setup">Odroid setup</h2>

<p>I downloaded Armbian for the HC1 here: <a href="https://www.armbian.com/odroid-hc1/" target="_blank">https://www.armbian.com/odroid-hc1/</a> and wrote the image to an SD card using <a href="https://www.balena.io/etcher/">Etcher</a>.
I‚Äôm using OSX on my machine.
If you‚Äôre on Windows, <a href="https://rufus.ie/" target="_blank">Rufus</a> is a good choice.</p>

<p>Once the Odroid boots up, find its MAC address in your router config and configure a static IP lease.
Mine has <code class="language-plaintext highlighter-rouge">192.168.0.11</code>. Then SSH in:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ssh root@192.168.0.11
</code></pre></div></div>

<p>It will ask you to change the root password and create a new user.
Once done, add your user to the <code class="language-plaintext highlighter-rouge">sudo</code> group and update:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>usermod <span class="nt">-aG</span> <span class="nb">sudo</span> &lt;username&gt;
<span class="nv">$ </span>apt update
<span class="nv">$ </span>apt upgrade
</code></pre></div></div>

<p>You should probably <code class="language-plaintext highlighter-rouge">su &lt;username&gt;</code>, but then you will have to <code class="language-plaintext highlighter-rouge">sudo</code> everything. ¬Ø\_(„ÉÑ)_/¬Ø</p>

<h3 id="mount-the-disk">Mount the disk</h3>

<p>Now is a good time to mount the HDD in <code class="language-plaintext highlighter-rouge">/mnt/hdd</code> and set it to mount on boot.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># find out where your disk is</span>
<span class="nv">$ </span>fdisk <span class="nt">-l</span>

<span class="c"># create a fresh partition</span>
<span class="nv">$ </span>parted /dev/sda
  <span class="o">&gt;</span> mklabel gpt <span class="c"># beware: this will erase all data on the drive</span>
  <span class="o">&gt;</span> mkpart primary 0TB 1TB <span class="c"># or however large your disk is</span>
  <span class="o">&gt;</span> quit

<span class="c"># create an Ext4 filesystem</span>
<span class="nv">$ </span>mkfs.ext4 /dev/sda1

<span class="c"># create the mount point</span>
<span class="nv">$ </span><span class="nb">mkdir</span> /mnt/hdd

<span class="c"># mount it to verify it works</span>
<span class="nv">$ </span>mount /dev/sda1 /mnt/hdd

<span class="c"># find your disk's UUID</span>
<span class="nv">$ </span>blkid <span class="nt">-o</span> list

<span class="c"># add this line to /etc/fstab to mount on boot</span>
<span class="nv">$ </span>vi /etc/fstab
  <span class="c"># ...snip...</span>
  <span class="nv">UUID</span><span class="o">=</span>&lt;uuid&gt; /mnt/hdd ext4 defaults 0 2

<span class="c"># after reboot, disk should be mounted in /mnt/hdd</span>
<span class="nv">$ </span>reboot
</code></pre></div></div>

<h2 id="nfs-setup">NFS setup</h2>

<p>Install the NFS server:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>apt <span class="nb">install </span>autofs nfs-kernel-server nfs-common <span class="nt">--install-recommends</span> <span class="nt">-f</span> <span class="nt">-y</span>
<span class="nv">$ </span>reboot
</code></pre></div></div>

<p>Configure the share:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># the share will live in a subdirectory. That way you can add data to the disk that will not be shared</span>
<span class="nv">$ </span><span class="nb">mkdir</span> /mnt/hdd/data

<span class="c"># back up default NFS config</span>
<span class="nv">$ </span><span class="nb">cp</span> <span class="nt">-a</span> /etc/exports /etc/exports.backup

<span class="c"># configure the share</span>
<span class="nv">$ </span>vi /etc/exports
  <span class="c"># data_directory  host(attributes)</span>
  /mnt/hdd/data <span class="k">*</span><span class="o">(</span>rw,async,insecure,all_squash,no_subtree_check,nohide,anonuid<span class="o">=</span>1000,anongid<span class="o">=</span>1000<span class="o">)</span>
</code></pre></div></div>

<p>Attributes:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">rw</code> - read/write</li>
  <li><code class="language-plaintext highlighter-rouge">async</code> - allows the server to buffer writes</li>
  <li><code class="language-plaintext highlighter-rouge">insecure</code> - allows clients (eg. Mac OS X) to use non-reserved ports to connect to the share</li>
  <li><code class="language-plaintext highlighter-rouge">no_subtree_check</code> - improves speed and reliability by eliminating permission checks on parent directories</li>
  <li><code class="language-plaintext highlighter-rouge">nohide</code> - not a hidden share</li>
  <li><code class="language-plaintext highlighter-rouge">all_squash</code> - treats all users as anonymous and assigns them uid=anonuid &amp; gid=anongid</li>
  <li><code class="language-plaintext highlighter-rouge">anonuid=1000</code> - assigns anonymous users uid 1000</li>
  <li><code class="language-plaintext highlighter-rouge">anongid=1000</code> - assigns anonymous users gid 1000</li>
</ul>

<p>Change the <code class="language-plaintext highlighter-rouge">uid</code> and <code class="language-plaintext highlighter-rouge">gid</code> to match the owner of the <code class="language-plaintext highlighter-rouge">/mnt/hdd/data</code> directory.
That way every client will have full access to the share.
Use this only on your private network!</p>

<p>Restart to apply changes:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># if you make additional changes, run this first</span>
<span class="nv">$ </span>exportfs <span class="nt">-ra</span>

<span class="c"># restart the server</span>
<span class="nv">$ </span>service nfs-kernel-server restart
</code></pre></div></div>

<h3 id="add-a-test-nfs-client">Add a test NFS client</h3>

<p>Mount the NFS share on your computer to verify it works.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># find out if the share is advertised</span>
<span class="nv">$ </span>showmount <span class="nt">-e</span> 192.168.0.11

<span class="c"># mount it to /Users/&lt;username&gt;/odroid</span>
<span class="nv">$ </span>mount <span class="nt">-t</span> nfs <span class="nt">-o</span> <span class="nv">rsize</span><span class="o">=</span>65536,wsize<span class="o">=</span>65536,intr,hard,tcp,locallocks,rdirplus,readahead<span class="o">=</span>128 192.168.0.11:/mnt/hdd/data /Users/&lt;username&gt;/odroid
</code></pre></div></div>

<p>Check if you see it in Finder and copy some files.
If it works, unmount and set up an auto mount:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># unmount</span>
<span class="nv">$ </span>umount /Users/&lt;username&gt;/odroid

<span class="c"># add auto_nfs to auto_master</span>
<span class="nv">$ </span><span class="nb">sudo </span>vi /etc/auto_master
  /-          auto_nfs    <span class="nt">-nobrowse</span>,nosuid

<span class="c"># add the share to auto_nfs</span>
<span class="nv">$ </span><span class="nb">sudo </span>vi /etc/auto_nfs
  /System/Volumes/Data/Users/&lt;username&gt;/odroid <span class="nt">-fstype</span><span class="o">=</span>nfs,noowners,nolockd,locallocks,rdirplus,hard,intr,rw,tcp,nfc,rsize<span class="o">=</span>65536,wsize<span class="o">=</span>65536 nfs://192.168.0.11:/mnt/hdd/data

<span class="c"># set proper permissions: a+rwx,u-x,g-wx,o-wx</span>
<span class="nv">$ </span><span class="nb">sudo chmod </span>644 /etc/auto_nfs

<span class="c"># mount everything in auto_master</span>
<span class="nv">$ </span><span class="nb">sudo </span>automount <span class="nt">-cv</span>
</code></pre></div></div>

<p>You should find the volume in <code class="language-plaintext highlighter-rouge">/Users/&lt;username&gt;/odroid</code>.
Verify it still works.</p>

<h2 id="backup-setup">Backup setup</h2>

<p>Register for a Backblaze account at <a href="https://www.backblaze.com/b2/cloud-storage.html" target="_blank">https://www.backblaze.com/b2/cloud-storage.html</a>.
(You can use any other cloud storage provider supported by <code class="language-plaintext highlighter-rouge">rclone</code>, which is most of them.)
Create a private bucket with versioning on (it‚Äôs the default for B2).</p>

<p>Side note: if you create a public bucket, you can <a href="https://help.backblaze.com/hc/en-us/articles/217666928-Using-Backblaze-B2-with-the-Cloudflare-CDN" target="_blank">proxy traffic</a> to it through Cloudflare to create your own private CDN.</p>

<p>Next, create an app key with permissions to your bucket and save the app key ID and the key to configure <code class="language-plaintext highlighter-rouge">rclone</code>.</p>

<h3 id="install--configure-rclone">Install &amp; configure rclone</h3>

<p>Rclone is an amazing CLI utility that supports a lot of cloud storage providers.
It‚Äôs basically rsync for the cloud. Let‚Äôs install rclone and add B2 as a remote:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># install rclone</span>
<span class="nv">$ </span>apt <span class="nb">install </span>rclone

<span class="c"># add a remote</span>
<span class="nv">$ </span>rclone config
  No remotes found - make a new one
  n<span class="o">)</span> New remote
  s<span class="o">)</span> Set configuration password
  q<span class="o">)</span> Quit config

  n/s/q&gt; n

  name&gt; b2

  Type of storage to configure.
  Enter a string value. Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">""</span><span class="o">)</span><span class="nb">.</span>
  Choose a number from below, or <span class="nb">type </span><span class="k">in </span>your own value
  ...snip...
  4 / Amazon S3 Compliant Storage Providers <span class="o">(</span>AWS, Ceph, Dreamhost, IBM COS, Minio<span class="o">)</span>
    <span class="se">\ </span><span class="s2">"s3"</span>
  5 / Backblaze B2
    <span class="se">\ </span><span class="s2">"b2"</span>
  ...snip...

  Storage&gt; b2

  <span class="k">**</span> See <span class="nb">help </span><span class="k">for </span>b2 backend at: https://rclone.org/b2/ <span class="k">**</span>

  Account ID or Application Key ID
  Enter a string value. Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">""</span><span class="o">)</span><span class="nb">.</span>
  account&gt; 0000000000000000000
  Application Key
  Enter a string value. Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">""</span><span class="o">)</span><span class="nb">.</span>

  key&gt; <span class="k">*</span>876FD87SFGadsfSD08F6fD087Fadf07SF608D6fdsfzgjhsdfgd76<span class="k">*</span>

  Permanently delete files on remote removal, otherwise hide files.
  Enter a boolean value <span class="o">(</span><span class="nb">true </span>or <span class="nb">false</span><span class="o">)</span><span class="nb">.</span> Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">"false"</span><span class="o">)</span><span class="nb">.</span>

  hard_delete&gt; <span class="nb">false

  </span>Edit advanced config? <span class="o">(</span>y/n<span class="o">)</span>
  y<span class="o">)</span> Yes
  n<span class="o">)</span> No
  y/n&gt; n

  Remote config
  <span class="nt">--------------------</span>
  <span class="o">[</span>b2]
  account <span class="o">=</span> 0000000000000000000
  key <span class="o">=</span> 876FD87SFGadsfSD08F6fD087Fadf07SF608D6fdsfzgjhsdfgd76
  hard_delete <span class="o">=</span> <span class="nb">false</span>
  <span class="nt">--------------------</span>

  y<span class="o">)</span> Yes this is OK
  e<span class="o">)</span> Edit this remote
  d<span class="o">)</span> Delete this remote

  y/e/d&gt; y
</code></pre></div></div>

<p>To test that it worked, create a file in <code class="language-plaintext highlighter-rouge">/mnt/hdd/data</code> and run rclone:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># create a file</span>
<span class="nv">$ </span><span class="nb">touch</span> /mnt/hdd/data/test-file

<span class="c"># sync to B2</span>
<span class="nv">$ </span>rclone <span class="nb">sync</span> /mnt/hdd/data b2:&lt;bucket-name&gt;
</code></pre></div></div>

<p>See if the file was uploaded in B2 management console.</p>

<h3 id="enable-encryption">Enable encryption</h3>

<p>To enable encryption, rclone has a <code class="language-plaintext highlighter-rouge">crypt</code> remote type that encrypts files uploaded to it.
Most of the configuration is straightforward and uses the defaults, except for filename and directory name encryption, which <a href="https://github.com/rclone/rclone/issues/1627#issuecomment-371625277" target="_blank">does not work with B2 versioning system</a>, so we will disable it.
If you insist on encrypting file and directory names, you could disable versioning and use the <code class="language-plaintext highlighter-rouge">--backup-dir</code> option instead.</p>

<p>Let‚Äôs add another remote:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rclone config
  n<span class="o">)</span> New remote
  s<span class="o">)</span> Set configuration password
  q<span class="o">)</span> Quit config

  n/s/q&gt; n

  name&gt; b2-crypt-backup

  Type of storage to configure.
  Enter a string value. Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">""</span><span class="o">)</span><span class="nb">.</span>
  Choose a number from below, or <span class="nb">type </span><span class="k">in </span>your own value
  ...snip...
  9 / Encrypt/Decrypt a remote
    <span class="se">\ </span><span class="s2">"crypt"</span>
  ...snip...

  Storage&gt; crypt

  <span class="k">**</span> See <span class="nb">help </span><span class="k">for </span>crypt backend at: https://rclone.org/crypt/ <span class="k">**</span>

  Remote to encrypt/decrypt.
  Normally should contain a <span class="s1">':'</span> and a path, eg <span class="s2">"myremote:path/to/dir"</span>,
  <span class="s2">"myremote:bucket"</span> or maybe <span class="s2">"myremote:"</span> <span class="o">(</span>not recommended<span class="o">)</span><span class="nb">.</span>
  Enter a string value. Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">""</span><span class="o">)</span><span class="nb">.</span>

  remote&gt; b2:&lt;bucket-name&gt;

  How to encrypt the filenames.
  Enter a string value. Press Enter <span class="k">for </span>the default <span class="o">(</span><span class="s2">"standard"</span><span class="o">)</span><span class="nb">.</span>
  Choose a number from below, or <span class="nb">type </span><span class="k">in </span>your own value
  1 / Don<span class="s1">'t encrypt the file names.  Adds a ".bin" extension only.
    \ "off"
  2 / Encrypt the filenames see the docs for the details.
    \ "standard"
  3 / Very simple filename obfuscation.
    \ "obfuscate"

  filename_encryption&gt; off

  Option to either encrypt directory names or leave them intact.
  Enter a boolean value (true or false). Press Enter for the default ("true").
  Choose a number from below, or type in your own value
  1 / Encrypt directory names.
    \ "true"
  2 / Don'</span>t encrypt directory names, leave them intact.
    <span class="se">\ </span><span class="s2">"false"</span>

  directory_name_encryption&gt; <span class="nb">false

  </span>Password or pass phrase <span class="k">for </span>encryption.
  y<span class="o">)</span> Yes <span class="nb">type </span><span class="k">in </span>my own password
  g<span class="o">)</span> Generate random password
  n<span class="o">)</span> No leave this optional password blank

  y/g/n&gt; g

  Password strength <span class="k">in </span>bits.
  64 is just about memorable
  128 is secure
  1024 is the maximum

  Bits&gt; 1024

  Your password is: zFpNRENxx75Eks3GftRzhDdRYFO8U8oAWTIwezf5Qnj5HPwAxypXDZb4LGy1wJSUGPo4c9aj4GLhQ87Gcw3ar6ve7TET77NORkAyhKwkR6BwPk4jVGRi-YMkjIf6oqDPdRRB3RQUhtFKp5VtBQl-txe-luOQlHR2-zQ_YiamuAg
  Use this password? Please note that an obscured version of this
  password <span class="o">(</span>and not the password itself<span class="o">)</span> will be stored under your
  configuration file, so keep this generated password <span class="k">in </span>a safe place.
  y<span class="o">)</span> Yes
  n<span class="o">)</span> No

  y/n&gt; y

  Password or pass phrase <span class="k">for </span>salt. Optional but recommended.
  Should be different to the previous password.
  y<span class="o">)</span> Yes <span class="nb">type </span><span class="k">in </span>my own password
  g<span class="o">)</span> Generate random password
  n<span class="o">)</span> No leave this optional password blank

  y/g/n&gt; g

  Password strength <span class="k">in </span>bits.
  64 is just about memorable
  128 is secure
  1024 is the maximum

  Bits&gt; 1024

  Your password is: CadSQrSUqAAGOfNzr6-__Rsdv8Bauj2lG8Ee2Q7oFZh7MByhnRFyUGLoX5yXX1dKRKKxMCpoG5-OQlKgascKd-aU9p9sGAeVpzs301zzwrRI8ngE8XtPE8Qzx_HZvZAMqVSy1gl-zGhqqnsdCLuty5VbBtk2PJwQ9Hlq1XygxCA
  Use this password? Please note that an obscured version of this
  password <span class="o">(</span>and not the password itself<span class="o">)</span> will be stored under your
  configuration file, so keep this generated password <span class="k">in </span>a safe place.
  y<span class="o">)</span> Yes
  n<span class="o">)</span> No

  y/n&gt; y

  Edit advanced config? <span class="o">(</span>y/n<span class="o">)</span>
  y<span class="o">)</span> Yes
  n<span class="o">)</span> No

  y/n&gt; n

  Remote config
  <span class="nt">--------------------</span>
  <span class="o">[</span>b2-crypt-backup]
  remote <span class="o">=</span> b2:&lt;bucket-name&gt;
  filename_encryption <span class="o">=</span> off
  directory_name_encryption <span class="o">=</span> <span class="nb">false
  </span>password <span class="o">=</span> <span class="k">***</span> ENCRYPTED <span class="k">***</span>
  password2 <span class="o">=</span> <span class="k">***</span> ENCRYPTED <span class="k">***</span>
  <span class="nt">--------------------</span>
  y<span class="o">)</span> Yes this is OK
  e<span class="o">)</span> Edit this remote
  d<span class="o">)</span> Delete this remote

  y/e/d&gt; y
</code></pre></div></div>

<p><strong>Save the keys to your password manager.</strong>
You will need them to restore your files.</p>

<p>Check that the encrypted remote works the same way we checked the B2 remote:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># create a file</span>
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"unencrypted text"</span> <span class="o">&gt;</span> /mnt/hdd/data/test-plain-file

<span class="c"># sync to B2</span>
<span class="nv">$ </span>rclone <span class="nb">sync</span> /mnt/hdd/data b2-crypt-backup:/
</code></pre></div></div>

<p>The file should show up in the management console with a <code class="language-plaintext highlighter-rouge">.bin</code> extension and encrypted contents.</p>

<p><strong>Test that you‚Äôre able to restore the data.</strong>
This step is crucial, without it you‚Äôre uploading random bytes to the cloud.
On the Odroid:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># copy your config</span>
<span class="nv">$ </span><span class="nb">cat</span> <span class="si">$(</span>rclone config file | <span class="nb">tail</span> <span class="nt">-n1</span><span class="si">)</span>
</code></pre></div></div>

<p>On another machine:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># paste your config</span>
<span class="nv">$ </span>rclone config edit

<span class="c"># restore the files, decrypting them in the process</span>
<span class="nv">$ </span>rclone <span class="nb">sync </span>b2-crypt-backup:/ /Users/&lt;username&gt;/test
</code></pre></div></div>

<p>Confirm that the file is restored and its contents have been decrypted.</p>

<h2 id="schedule-rclone-to-sync-periodically">Schedule rclone to sync periodically</h2>

<p>I used <code class="language-plaintext highlighter-rouge">cron</code> to automate running <code class="language-plaintext highlighter-rouge">rclone</code> every 30 minutes.
Create a bash script in <code class="language-plaintext highlighter-rouge">/home/&lt;username&gt;/rclone-cron.sh</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="k">if </span>pidof <span class="nt">-o</span> %PPID <span class="nt">-x</span> ‚Äúrclone-cron.sh‚Äù<span class="p">;</span> <span class="k">then
</span><span class="nb">exit </span>1
<span class="k">fi
</span>rclone <span class="nb">sync</span> <span class="nt">--fast-list</span> <span class="nt">--stats-log-level</span> NOTICE <span class="nt">--stats-one-line</span> <span class="nt">--log-file</span><span class="o">=</span>/var/log/rclone.log /mnt/hdd/data b2-crypt-backup:/
<span class="nb">exit</span>
</code></pre></div></div>

<p>If your storage provider bills you for every transaction (B2 does), I recommend to use <code class="language-plaintext highlighter-rouge">--fast-list</code>, which will minimize the amount of transactions at the expense of higher memory usage and result in a lower monthly payment.</p>

<p>I enabled logging to file for easier monitoring with <code class="language-plaintext highlighter-rouge">--stats-log-level NOTICE --stats-one-line --log-file=/var/log/rclone.log</code>.</p>

<p>The script runs <code class="language-plaintext highlighter-rouge">rclone sync</code>, but only if another instance of the script is not already running.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># set the executable bit</span>
<span class="nv">$ </span><span class="nb">chmod </span>a+x rclone-cron.sh

<span class="c"># add this line to crontab</span>
<span class="nv">$ </span>crontab <span class="nt">-e</span>
  0,30 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /home/&lt;username&gt;/rclone-cron.sh <span class="o">&gt;</span>/dev/null 2&gt;&amp;1
</code></pre></div></div>

<p>If you‚Äôd like to change the schedule, <a href="https://crontab.guru/#0,30_*_*_*_*" target="_blank">crontab.guru</a> is handy when editing crontab.</p>

<p>That‚Äôs it! Anything you store on the Odroid will be backed up to Backblaze every 30 minutes.
Previous versions of edited or deleted files will remain in Backblaze.
You can recover them using <code class="language-plaintext highlighter-rouge">rclone --b2-versions</code>.
You‚Äôll find more about that in the <a href="https://rclone.org/b2/#versions" target="_blank">docs</a>.</p>


      </main>
    </div>
    <script>
      function applyTheme(theme) {
  document.documentElement.classList.toggle('dark', theme === 'dark')
}

const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
applyTheme(isDark ? 'dark' : 'light')

document.getElementById('theme-toggle').addEventListener('click', function() {
  const newTheme = !('theme' in localStorage) ?
    document.documentElement.classList.contains('dark') ? 'light' : 'dark' :
    localStorage.theme === 'dark' ? 'light' : 'dark'
  localStorage.theme = newTheme
  applyTheme(newTheme)
})

    </script>
  </body>
</html>
