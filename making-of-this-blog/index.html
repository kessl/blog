<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/assets/css/default.css?1657549141763759974">
    <link rel="stylesheet" href="/assets/css/fonts.css">
    <link rel="stylesheet" href="/assets/css/monokai.css">
    <link rel="icon" href="/assets/favicon.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Making-of this blog &middot; bitgate</title>
    <link type="application/atom+xml" rel="alternate" href="https://blog.bitgate.cz/feed.xml" />
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Making-of this blog" />
<meta name="author" content="daniel" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="TL;DR You‚Äôre looking at a static site generated by Next.js, hosted on GitLab pages." />
<meta property="og:description" content="TL;DR You‚Äôre looking at a static site generated by Next.js, hosted on GitLab pages." />
<link rel="canonical" href="https://blog.bitgate.cz/making-of-this-blog/" />
<meta property="og:url" content="https://blog.bitgate.cz/making-of-this-blog/" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-04-27T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Making-of this blog" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"daniel"},"dateModified":"2020-04-27T00:00:00+00:00","datePublished":"2020-04-27T00:00:00+00:00","description":"TL;DR You‚Äôre looking at a static site generated by Next.js, hosted on GitLab pages.","headline":"Making-of this blog","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.bitgate.cz/making-of-this-blog/"},"url":"https://blog.bitgate.cz/making-of-this-blog/"}</script>
<!-- End Jekyll SEO tag -->

  </head>
  <body>
    <button id="theme-toggle" class="hidden sm:block absolute top-30 right-30 border-none rounded-sm -mx-[5px] px-[5px] hover:bg-dark/10 dark:hover:bg-light/10">
  <span class="hidden dark:inline" title="switch to light theme">‚òÄÔ∏è</span>
  <span class="dark:hidden" title="switch to dark theme">üåë</span>
</button>

    <div class="overflow-x-hidden">
      <div class="golden bg-grid">
        <nav class="flex justify-center space-x-30 sm:space-x-60 underline">
  
    <a href="/">/</a>
  
    <a href="/about">/about</a>
  
    <a href="/archive">/archive</a>
  
    <a href="/tags">/tags</a>
  
</nav>

        <main class="mt-30 md:mt-60 max-w-none prose">
          <h1>Making-of this blog</h1>
<p class="text-sm text-muted my-15">
  written by daniel in
  
    <a href="/tags/frontend"><code>frontend</code></a>
  
    <a href="/tags/devops"><code>devops</code></a>
  
  on 27 Apr 2020
</p>
<p><strong>TL;DR</strong> You‚Äôre looking at a static site generated by Next.js, hosted on GitLab pages.</p>

<p>I wanted a place to store thoughts and ideas.
This site is the overengineered result of procrastinating from actually writing the content.</p>

<h2 id="why-nextjs">Why Next.js?</h2>

<p>A static site was an obvious choice.
The content won‚Äôt change very often, it‚Äôs fast, I can host it on <code class="language-plaintext highlighter-rouge">Git(Lab|Hub)</code> pages for free.
There are dedicated static site generators like Gatsby, but I decided to go with Next‚Äôs static HTML export (introduced in Next 9.3).
Next has a lot of awesome features that make development (and writing posts locally) much easier, like out of the box support for hot reloading and CSS modules.</p>

<p><del>The result is an SPA with a 73 KB first load. Subsequent page transitions are client-side and only fetch JSON data.
Still works flawlessly with Javascript turned off.</del></p>

<p><a name="no-js"><em>Update 2021-01-15:</em></a> I found an <a href="https://github.com/vercel/next.js/pull/11949" target="_blank">unstable Next.js page-level config option</a> to turn off all runtime JS.
The result is 7.54 KB transferred (compressed) on first load.</p>

<div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">unstable_runtimeJS</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="how-this-works">How this works</h3>

<p>Next.js pages fetch data from Markdown files at build time with the use of <a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticprops-static-generation" target="_blank"><code class="language-plaintext highlighter-rouge">getStaticProps</code></a>.
Next exports all pages static and dynamic (as defined in <a href="https://nextjs.org/docs/basic-features/data-fetching#getstaticpaths-static-generation" target="_blank"><code class="language-plaintext highlighter-rouge">getStaticPaths</code></a>) as HTML files which I deploy to GitLab pages through a CI pipeline.</p>

<h3 id="try-it-for-yourself">Try it for yourself</h3>

<p>Clone <a href="https://gitlab.com/kessl/blog" target="_blank"><code class="language-plaintext highlighter-rouge">https://gitlab.com/kessl/blog</code></a>, install, add a new post, run dev server.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone https://gitlab.com/kessl/blog
<span class="nv">$ </span><span class="nb">cd </span>blog <span class="o">&amp;&amp;</span> yarn <span class="nb">install</span>
<span class="nv">$ </span>yarn add-post <span class="s2">"New post title"</span> tag tag2 ... <span class="c"># add a new post</span>
<span class="nv">$ </span>yarn dev
</code></pre></div></div>

<p>You can continue editing the newly created post in <code class="language-plaintext highlighter-rouge">posts/new-post-title.md</code>.
Once you‚Äôre done writing, commit the changes and push to GitLab to deploy the piece to pages.</p>

<p>If you‚Äôd like to base your own site on this without the color scheme and posts, clone a more barebones version from <code class="language-plaintext highlighter-rouge">v1.1.0</code>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone <span class="nt">--branch</span> v1.1.0 <span class="nt">--single-branch</span> https://gitlab.com/kessl/blog
<span class="nv">$ </span><span class="nb">cd </span>blog <span class="o">&amp;&amp;</span> git switch <span class="nt">-c</span> master
</code></pre></div></div>

<h2 id="deploying-to-gitlab-pages">Deploying to GitLab pages</h2>

<p>The deploy to GitLab pages was pretty straightforward.
I ended up with 3 stages in the pipeline:</p>

<ul>
  <li>install dependencies</li>
  <li>build &amp; export HTML (needs git installed to determine last commit date per post)</li>
  <li>gzip, copy to <code class="language-plaintext highlighter-rouge">public</code> folder, deploy to pages</li>
</ul>

<p>GitLab pages can serve gzip and brotli <a href="https://gitlab.com/gitlab-org/gitlab-pages/-/merge_requests/25" target="_blank">compressed files</a>, if you pre-compress them prior to deploying.
See the pipeline config in <a href="https://gitlab.com/kessl/blog/-/blob/master/.gitlab-ci.yml#L49" target="_blank"><code class="language-plaintext highlighter-rouge">.gitlab.ci</code></a> for how I did it here.</p>

<p>I‚Äôm using a <a href="https://gist.github.com/kessl/d5ec24894833f7af5d10101128145b0d" target="_blank">simple Cloudflare worker</a> to add basic security headers.</p>

<h2 id="thats-it">That‚Äôs it!</h2>

<p>I‚Äôm pretty happy with the setup.
I find writing in Markdown very convenient, the site is fast <del>(landing page is 73 KB gzipped, 212 KB uncompressed), responsive and works with Javascript off.</del>
(landing page is 7.54 KB brotli, 29.56 KB uncompressed) and there‚Äôs no JS.</p>

<p>What I‚Äôm missing is some sort of usage statistics.
GitLab unfortunately does not provide any access logs for pages, and I‚Äôm not going to ruin a static site with a JS tracking script.
A tracking pixel would work but still need to be hosted somewhere.</p>

<p><em>Update: I got around to setting up a <a href="/static-site-analytics-with-nginx-goaccess-no-js" target="_blank">GoAccess tracking pixel</a>.</em></p>


        </main>
        
          <nav class="mt-150 flex justify-center space-x-30 sm:space-x-60 underline text-sm text-dark-80">
  
    <a href="/">/</a>
  
    <a href="/about">/about</a>
  
    <a href="/archive">/archive</a>
  
    <a href="/tags">/tags</a>
  
</nav>

        
      </div>
    </div>
    <script>
      function applyTheme(theme) {
  document.documentElement.classList.toggle('dark', theme === 'dark')
}

const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
applyTheme(isDark ? 'dark' : 'light')

document.getElementById('theme-toggle').addEventListener('click', function() {
  const newTheme = !('theme' in localStorage) ?
    document.documentElement.classList.contains('dark') ? 'light' : 'dark' :
    localStorage.theme === 'dark' ? 'light' : 'dark'
  localStorage.theme = newTheme
  applyTheme(newTheme)
})

    </script>
  </body>
</html>
