<!DOCTYPE html>
<body style="background: #f0f0f0">
  <button id="btn" style="position: relative; z-index: 1">do something</button>
  <pre id="app"></pre>
  <canvas id="canvas" width="800" height="600" style="position: fixed; top: 0; left: 0; opacity: 0.5"></canvas>
  <script>
    const app = document.getElementById("app")
    const btn = document.getElementById("btn")
    const canvas = document.getElementById("canvas")
    const ctx = canvas.getContext("2d")

    const cellSize = 16

    function dump(buffer) {
      let dump = ''
      for (let i = 0; i < 65_536; i++) {
        if (i % 64 === 0) dump += `\n${i.toString(16).padStart(5, '0')}:`
        dump += ` ${buffer[i].toString(16).padStart(2, '0')}`
      }
      app.textContent = dump
    }

    function render(buffer, page_size, cols) {
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      for (let i = 0; i < page_size; i++) {
        if (!buffer[i]) continue
        const x = i % cols
        const y = ~~(i / cols)
        ctx.fillStyle = `rgb(0, 0, 0)`
        ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize)
      }
    }

    function update(instance) {
      const { page_size, cols, memory, offset } = instance.exports
      const buffer = new Uint8Array(memory.buffer, offset.value, page_size.value)

      dump(buffer)
      render(buffer, page_size.value, cols.value)
    }

    function init(instance) {
      const { cols, memory, offset, page_size } = instance.exports

      canvas.addEventListener('click', (event) => {
        const x = ~~(event.offsetX / cellSize)
        const y = ~~(event.offsetY / cellSize)

        const buffer = new Uint8Array(memory.buffer, offset.value, page_size.value)
        buffer[y * cols.value + x] = +!buffer[y * cols.value + x]

        update(instance)
      })

      update(instance)
    }

    const imports = {
      console: { log: console.log },
    }

    WebAssembly.instantiateStreaming(fetch("build/game.wasm"), imports).then((obj) => {
      const { next_gen } = obj.instance.exports

      btn.onclick = () => {
        next_gen()
        update(obj.instance)
      }

      init(obj.instance)
    })
  </script>
</body>
