<!DOCTYPE html>
<body style="background: #f0f0f0">
  <button id="btn" style="position: relative; z-index: 1">do something</button>
  <pre id="app" style="font: 10px monospace"></pre>
  <canvas id="canvas" width="800" height="600" style="position: fixed; top: 0; left: 0; opacity: 0.5"></canvas>
  <script>
    const app = document.getElementById("app")
    const btn = document.getElementById("btn")
    const canvas = document.getElementById("canvas")
    const ctx = canvas.getContext("2d")

    const cellSize = 16

    function dump(buffer) {
      let dump = ''
      for (let i = 0; i < 65_536; i++) {
        if (i % 64 === 0) dump += `\n${i.toString(16).padStart(5, '0')}:`
        dump += ` ${buffer[i].toString(16).padStart(2, '0')}`
      }
      app.textContent = dump
    }

    function render(buffer, page_size, cell_size, cols) {
      ctx.clearRect(0, 0, canvas.width, canvas.height)
      for (let i = 0; i < page_size; i += cell_size) {
        if (!buffer[i + 2] && !buffer[i + 1] && !buffer[i]) continue
        const x = ~~((i / cell_size) % cols)
        const y = ~~((i / cell_size) / cols)
        ctx.fillStyle = `rgb(${buffer[i + 2]}, ${buffer[i + 1]}, ${buffer[i]})`
        ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize)
      }
    }

    function update(instance) {
      const { page_size, cell_size, cols, memory, offset } = instance.exports
      const buffer = new Uint8Array(memory.buffer, offset.value, page_size.value)
      dump(buffer)
      render(buffer, page_size.value, cell_size.value, cols.value)
    }

    function init(instance) {
      const { cols, memory, offset, page_size, cell_size } = instance.exports

      let color = null
      let timeout = null
      canvas.addEventListener('click', (event) => {
        const x = ~~(event.offsetX / cellSize)
        const y = ~~(event.offsetY / cellSize)

        const buffer = new Uint8Array(memory.buffer, offset.value, page_size.value)
        const index = (y * cols.value + x) * cell_size.value

        clearTimeout(timeout)
        timeout = setTimeout(() => {
          color = null
        }, 1000)
        if (!color) {
          color = [~~(Math.random() * 255), ~~(Math.random() * 255), ~~(Math.random() * 255)]
        }

        if (!buffer[index + 2] && !buffer[index + 1] && !buffer[index]) {
          buffer[index + 2] = color[0]
          buffer[index + 1] = color[1]
          buffer[index] = color[2]
        } else {
          buffer[index + 2] = 0
          buffer[index + 1] = 0
          buffer[index] = 0
        }

        update(instance)
      })

      update(instance)
    }

    const imports = {
      console: { log: console.log },
    }

    WebAssembly.instantiateStreaming(fetch('/assets/build/game.wasm'), imports).then((obj) => {
      const { next_gen } = obj.instance.exports

      btn.onclick = () => {
        next_gen()
        update(obj.instance)
      }

      init(obj.instance)
    })
  </script>
</body>
